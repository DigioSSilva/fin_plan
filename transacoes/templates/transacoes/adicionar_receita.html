<div class="modal fade" id="modalAdicionarReceita" tabindex="-1" aria-labelledby="modalAdicionarReceitaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAdicionarReceitaLabel">Adicionar Receita</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="receitaForm" method="post" action="{% url 'adicionar_receita' %}">
          {% csrf_token %}

          <div id="mensagem-sucesso-receita" class="alert alert-success" style="display: none;">
            Receita salva com sucesso!
          </div>
          <div id="mensagem-erro-receita" class="alert alert-danger" style="display: none;"></div>

          <div class="mb-3">
            <label for="id_descricao" class="form-label">Descrição</label>
            <input type="text" id="id_descricao" name="descricao" class="form-control" placeholder="Ex: Salário" required>
          </div>

          <div class="mb-3">
            <label for="id_categoria" class="form-label">Categoria</label>
            <select id="id_categoria" name="categoria" class="form-control" required>
              <option value="" disabled selected>Selecione uma categoria</option>
              {% for categoria in categorias_receita %}
                <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="id_data" class="form-label">Data</label>
            <input type="date" id="id_data" name="data" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="id_valor" class="form-label">Valor</label>
            <input type="text" id="id_valor" name="valor" class="form-control" placeholder="Ex: 1500,00" required>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-success btn-lg" form="receitaForm">Salvar Receita</button>
        <button type="button" class="btn btn-secondary ms-3" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#receitaForm').submit(function(event) {
      event.preventDefault(); // Impede o envio padrão do formulário

      var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      var formData = $(this).find(':input').not(':submit').serialize();

      $.ajax({
        type: 'POST',
        url: $(this).attr('action'),
        data: formData,
        dataType: 'json',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken
        },
        success: function(response) {
          if (response.success) {
            $('#mensagem-sucesso-receita').text(response.message).show();
            $('#mensagem-erro-receita').hide();
            $('#receitaForm')[0].reset();
            $('#id_descricao').focus();
          } else {
            let errorMessages = '';
            if (response.errors) {
              $.each(response.errors, function(field, errors) {
                errorMessages += field + ': ' + errors.join(', ') + '<br>';
              });
            } else {
              errorMessages = response.message;
            }
            $('#mensagem-erro-receita').html(errorMessages).show();
          }
        },
        error: function(xhr, status, error) {
          $('#mensagem-erro-receita').html('Ocorreu um erro ao salvar a receita.').show();
        }
      });
    });

    // Recarregar a página ao fechar o modal
    $('#modalAdicionarReceita').on('hidden.bs.modal', function() {
      location.reload();
    });
  });
</script>
